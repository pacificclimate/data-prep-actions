# Pregenerate plan2adapt actions

A visitor to the plan2adapt web portal selects a region and a climatology  (2020s, 2050s, or 2080s). Then the portal shows them information about their selection. One of those is the summary table, which shows them the 10-90 percentile range for each of six variables across the twelve models of the PCIC12 ensemble, something like this but with better formatting:

| Climate Variable                                                                              | Season | Projected Change from 1961-1990 Baseline |                                 |
|-----------------------------------------------------------------------------------------------|--------|------------------------------------------|---------------------------------|
|                                                                                               |        | Ensemble Median                          | Range (10th to 90th percentile) |
| Temperature (째C)                                                                              | Annual | +3.2 째C                                  | +2.3 째C to +4.2 째C              |
| Precipitation (%)                                                                             | Annual | +7.0%                                    | +2.0% to +11%                   |
|                                                                                               | Summer | +3.9%                                    | -11% to +13%                    |
|                                                                                               | Winter | +6.1%                                    | -0.23% to +8.9%                 |
| Precipitation as Snow* (%) CAUTION: This variable may have a low baseline. See note 2 below.  | Annual | -29%                                     | -33% to -24%                    |
|                                                                                               | Winter | -23%                                     | -25% to -16%                    |
|                                                                                               | Spring | -38%                                     | -51% to -34%                    |
| Growing Degree-Days* (degree-days)                                                            | Annual | +534 degree-days                         | +324 to +781 degree-days        |
| Heating Degree-Days* (degree-days)                                                            | Annual | -1130 degree-days                        | -1500 to -835 degree-days       |
| Frost-Free Days* (days)                                                                       | Annual | +43 days                                 | +34 to +58 days                 |                                                                               |

It has so far proven infeasible to calculate the values for each of the twelve models that are combined into the percentile ranges quickly enough to display them in the table on the webpage. Therefore we use this script, which precalculates values for each combination of region, climatology, variable, and model in advance using the climate explorer backend's [stats API](https://github.com/pacificclimate/climate-explorer-backend/blob/master/ce/api/stats.py), and stores them in CSV files, one for each region. Then the [percentileanomaly API](https://github.com/pacificclimate/climate-explorer-backend/blob/master/ce/api/percentileanomaly.py)  backend consults the environment variable named `REGION_DATA_DIRECTORY` to get the location of the CSV files, reads the stored per-model previously-stored `stats` calls, and combines the model results into percentile values to provide to the front end.

## Running the script
The script needs to be run in a virtual environment with the climate explorer backend (and therefor gdal) installed. It typically takes a little under an hour to do all 50ish regions.

The variables, models, climatologies, and scenarios of interest are hard-coded into the script as constant dictionaries at the beginning of the script. If you are storing queries for something other than p2a, or if p2a starts displaying more data, it should be straightforward to modify them.

### required arguments
1. *-p polygons* a csv file, generated by a geoserver instance, giving region geometry in WKT format. There's a copy in this repository, if the regions haven't changed (they probably haven't) named `bc-regions-polygon.csv`
2. *-n names* a csv file matching p2a's defined region keywords ("bc") with the formal names in the geoserver file. ("British Columbia"). There's a copy in this repository if the region haven't changed (they probably haven't) named `region-correspondance.csv`
3. *-m multimeta* a JSON file, the output of the `multimeta` query from Climate Explorer Backend, containing all the necessary datasets. Currently, the ensemble used by plan2adapt is the `p2a_classic` ensemble, though it's not inconceivable this could change. The ensemble needs to have a "baseline" dataset (ANUSPLIN 1961-1990 currently) for each variable, as well as projected datasets for the 2020s, 2050s, and 2080s for each variable and model for which stored queries are desired. It's important to have a fresh copy of the metadata - not only do we update our data fairly frequently, but there modtime in this file will be saved with the stored queries, and used by the `health` API to determine whether the stored queries are stale. You can get a fresh copy from the production backend [here](https://services.pacificclimate.org/pcex/api/multimeta?ensemble_name=p2a_classic). 
4. *-b baseline* the climatology and model to include as the baseline. Currently, one ONE baseline can be included. Long term we'd like to change this - we want to shift from a 1961-1990 baseline to a 1971-2000 baseline, in line with a broader shift at PCIC. Which will probably mean modifying this script to support both at once. But that hasn't happened yet. Specify like `6190,anusplin`
5. *-d dsn* connection string for a modelmeta database (the same one the `multimeta` metadata JSON file was generated from). Used to access time metadata.
6. *-r region* the p2a name of the region to calculate data for. To calculate all the region at once, you can just strip out the first column of `region-correspondance.csv`, get rid of the header, and do `for region in $(cat regionlist.txt); do python p2a-precalc.py -r $region -otherarguments ; done` 

### obsolete arguments
1. *-t tasmean* 
2. *-f ffd* 

Originally it was thought that we could just provide p2a's derived data ( `tasmean` (average of `tasmax` and `tasmin`) and `ffd` (arithmetic inverse of `fd`)) as stored queries for nonexistent datasets. These arguments tell the script to add additional rows corresponding to these variables and to calculate them from their inputs. However, we decided we wanted to show these "derived" variables as maps, which requried actually creating the datasets, making these arguments obsolete.

## a disaster waiting to happen
This script does NOT check the runs of PCIC12 models. You need to make sure the ensemble you are using contains the correct runs. That would be a good thing to fix someday!
